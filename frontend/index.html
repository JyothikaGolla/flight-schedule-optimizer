<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Flight Scheduler â€” Interactive</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>body{padding:20px;background:#f8fafc} .card{margin-bottom:16px}</style>
</head>
<body>
<div class="container">
  <h1 class="mb-3">Flight Scheduler â€” Interactive Prototype</h1>
  <div class="row">
    <div class="col-md-4">
      <div class="card p-3">
        <h5>Busiest Slots</h5>
        <p>Show busiest scheduled departure slots (hourly).</p>
        <button id="btnSlots" class="btn btn-primary btn-sm">Load Slots</button>
        <canvas id="slotsChart" height="200" style="max-height:240px"></canvas>
      </div>

      <div class="card p-3">
        <h5>Delay Summary</h5>
        <button id="btnStats" class="btn btn-secondary btn-sm">Load Stats</button>
        <pre id="statsPre" style="background:#001821;color:#bfefff;padding:8px;border-radius:6px;margin-top:8px"></pre>
      </div>

      <div class="card p-3">
        <h5>Optimize Schedule</h5>
        <p>Find a small shift to reduce cascade impact for a candidate flight.</p>
        <button id="btnOptimize" class="btn btn-success btn-sm">Run Optimizer</button>
        <pre id="optPre" style="background:#001821;color:#bfefff;padding:8px;border-radius:6px;margin-top:8px"></pre>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5>Search Flights</h5>
          <div>
            <input id="q" placeholder="Flight ID / Airline / Dest" class="form-control form-control-sm" style="display:inline-block;width:240px">
            <button id="btnSearch" class="btn btn-outline-primary btn-sm">Search</button>
          </div>
        </div>
        <div id="searchRes" style="max-height:480px;overflow:auto;margin-top:12px"></div>
      </div>

      <div class="card p-3">
        <h5>Top Cascade Flights</h5>
        <button id="btnCascade" class="btn btn-warning btn-sm">Load Top Cascade</button>
        <div id="cascadeRes" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
  <hr>
  <footer class="text-muted">Prototype â€” data synthetic. Backend must be running (uvicorn) at <code>http://127.0.0.1:8000</code></footer>
</div>

<script>
const apiBase = '';// served from same origin
document.getElementById('btnSlots').addEventListener('click', async ()=> {
  try {
    const res = await fetch(apiBase + '/busiest_slots?hour_bucket=1&top=12');
    const result = await res.json();

    console.log("ðŸ“Š Backend response:", result);

    const labels = result.labels;
    const vals = result.data;

    if (!labels || labels.length === 0) {
      alert("âš ï¸ No data received from backend!");
      return;
    }

    const canvas = document.getElementById('slotsChart');
    if (!canvas) {
      alert("âŒ slotsChart canvas not found in HTML!");
      return;
    }

    const ctx = canvas.getContext('2d');

    // âœ… Safe destroy
    if (window.slotsChart instanceof Chart) {
      window.slotsChart.destroy();
    }

    window.slotsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets:[{
          label: 'Flights',
          data: vals,
          backgroundColor: 'rgba(54, 162, 235, 0.7)'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { autoSkip: false } } }
      }
    });

    console.log("âœ… Chart rendered successfully");

  } catch (err) {
    console.error("âŒ Error loading slots:", err);
    alert("Error loading busiest slots");
  }
});


document.getElementById('btnStats').addEventListener('click', async ()=>{
  const res = await fetch(apiBase + '/delay_stats');
  const d = await res.json();
  document.getElementById('statsPre').textContent = JSON.stringify(d, null, 2);
});

document.getElementById('btnOptimize').addEventListener('click', async ()=>{
  document.getElementById('optPre').textContent = 'Running...';
  const res = await fetch(apiBase + '/optimize_schedule', {method:'POST'});
  const d = await res.json();
  document.getElementById('optPre').textContent = JSON.stringify(d, null, 2);
});

document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const q = document.getElementById('q').value;
  const res = await fetch(apiBase + '/search_flights?q=' + encodeURIComponent(q) + '&limit=100');
  const data = await res.json();
  const container = document.getElementById('searchRes');
  container.innerHTML = '<table class="table table-sm"><thead><tr><th>Flight</th><th>Airline</th><th>Dest</th><th>Sched Dep</th><th>Delay</th></tr></thead><tbody>' +
    data.map(r=>`<tr><td>${r.Flight_ID}</td><td>${r.Airline}</td><td>${r.Destination}</td><td>${r.Scheduled_Departure}</td><td>${r.Delay_Minutes}</td></tr>`).join('') +
    '</tbody></table>';
});

document.getElementById('btnCascade').addEventListener('click', async ()=>{
  const res = await fetch(apiBase + '/top_cascade_flights?window_min=120&top=10');
  const data = await res.json();
  const container = document.getElementById('cascadeRes');
  container.innerHTML = '<ol>' + data.map(r=>`<li><b>${r.Flight_ID}</b> (${r.Airline}) â€” Score: ${r.cascade_score} â€” Delay: ${r.Delay_Minutes} â€” ${r.Scheduled_Departure}</li>`).join('') + '</ol>';
});
</script>
</body>
</html>
